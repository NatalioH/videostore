pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/NatalioH/videostore.git'
      }
    }

    stage('Sanity: show files') {
      steps {
        bat '''
        echo WORKSPACE: %cd%
        dir
        echo ----
        dir mymovie
        '''
      }
    }

    stage('Build image in Minikube') {
      steps {
        bat '''
        REM Build directly with minikube (no docker-env needed)
        "C:\\Program Files\\minikube\\minikube.exe" image build -t mydjangoapp:latest mymovie
        '''
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        bat '''
        REM Use kubectl from PATH. If Jenkins can't find it, see Step 2 below.
        kubectl apply -f mymovie\\deployment.yaml
        kubectl apply -f mymovie\\service.yaml
        kubectl rollout status deployment/django-deployment
        kubectl get pods
        kubectl get svc
        '''
      }
    }
  }
}
